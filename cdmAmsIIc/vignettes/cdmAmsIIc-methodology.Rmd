---
title: "AMS-II.C Methodology Walkthrough"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{AMS-II.C Methodology Walkthrough}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Introduction

This vignette demonstrates how to reproduce the AMS-II.C calculations using
`cdmAmsIIc`. The methodology covers demand-side energy efficiency projects that
retrofit specific technologies (lighting, motors, HVAC, refrigeration) with more
efficient alternatives. The core steps include aggregating baseline and project
energy, computing energy savings, and converting the savings into emission
reductions with the appropriate grid or fuel emission factor.

# Applicability Checks

```{r applicability}
library(cdmAmsIIc)
check_applicability_energy_savings(annual_energy_savings_mwh = 42000)
check_applicability_technology(c("efficient_lighting", "variable_speed_drives"))
check_applicability_monitoring("continuous_metering")
```

# Simulated Dataset

```{r simulation}
set.seed(123)
example_data <- simulate_ams_iic_dataset(n_sites = 4, n_periods = 6, start_year = 2024, start_month = 7)
knitr::kable(
  head(example_data),
  format = "html",
  digits = 3
)
```

The simulation includes monitoring metadata (`monitoring_period`, `year`,
`month`, `day`, and `monitoring_label`) so that calculations can be aggregated
over reporting periods while preserving site-level identifiers and emission
factors.

# Equation Walkthrough

```{r calculations}
baseline_energy <- calculate_baseline_energy_consumption(example_data, group_cols = "site_id")
project_energy <- calculate_project_energy_consumption(example_data, group_cols = "site_id")
energy_savings <- calculate_energy_savings(baseline_energy, project_energy)
emission_reductions <- calculate_emission_reductions(
  energy_savings,
  emission_factor = example_data$emission_factor_tco2e_mwh[1]
)
knitr::kable(head(emission_reductions), format = "html", digits = 3)
```

# Monitoring Period Aggregation

```{r monitoring}
period_summary <- aggregate_monitoring_periods(
  efficiency_data = example_data,
  monitoring_cols = c("monitoring_label"),
  group_cols = "site_id",
  baseline_energy_col = "baseline_energy_mwh",
  project_energy_col = "project_energy_mwh",
  emission_factor_col = "emission_factor_tco2e_mwh"
)

knitr::kable(head(period_summary), format = "html", digits = 3)
```

# Meta-Function

```{r meta}
wrapper_results <- estimate_emission_reductions_ams_iic(
  baseline_data = example_data,
  project_data = example_data,
  emission_factor = example_data$emission_factor_tco2e_mwh[1],
  group_cols = "site_id",
  baseline_energy_col = "baseline_energy_mwh",
  project_energy_col = "project_energy_mwh"
)

knitr::kable(wrapper_results, format = "html", digits = 3)
```

# Function Interdependencies

```{mermaid}
flowchart TD
  A[calculate_baseline_energy_consumption] --> C[calculate_energy_savings]
  B[calculate_project_energy_consumption] --> C
  C --> D[calculate_emission_reductions]
  D --> E[estimate_emission_reductions_ams_iic]
```

# Function Reference Table

```{r reference-table}
library(dplyr)
reference <- tibble::tribble(
  ~Equation, ~Function, ~Description,
  "(1)", "calculate_baseline_energy_consumption()", "Aggregates baseline energy consumption prior to retrofits.",
  "(2)", "calculate_project_energy_consumption()", "Aggregates monitored project energy use of efficient technology.",
  "(3)", "calculate_energy_savings()", "Computes energy savings as baseline minus project energy.",
  "(4)", "calculate_emission_reductions()", "Converts energy savings to emission reductions using emission factors."
)
knitr::kable(reference, format = "html")
```
