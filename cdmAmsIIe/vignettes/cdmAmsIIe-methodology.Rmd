---
title: "AMS-II.E Methodology Walkthrough"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{AMS-II.E Methodology Walkthrough}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Introduction

This vignette demonstrates how to reproduce the AMS-II.E calculations using
`cdmAmsIIe`. The methodology covers building energy efficiency and fuel
switching projects that improve thermal and electrical performance. The core
steps include estimating baseline emissions, calculating project emissions,
accounting for leakage, and deriving net emission reductions.

# Applicability Checks

```{r applicability}
library(cdmAmsIIe)

baseline <- tibble::tibble(
  baseline_total_energy_mwh = c(220, 195),
  baseline_thermal_energy_gj = c(320, 180),
  baseline_thermal_emission_factor_tco2_per_gj = c(0.07, 0.072),
  service_level_indicator = c(4.2, 3.9)
)
project <- tibble::tibble(
  project_total_energy_mwh = c(150, 138),
  project_thermal_energy_gj = c(280, 120),
  project_thermal_emission_factor_tco2_per_gj = c(0.045, 0.05),
  service_level_indicator = c(4.2, 3.9)
)
monitoring <- tibble::tibble(
  building_id = c("Office_A", "Office_B"),
  project_total_energy_mwh = c(12.5, 11.2),
  service_level_indicator = c(0.35, 0.32),
  operating_hours = c(220, 215)
)

check_applicability_energy_efficiency(
  baseline,
  project,
  energy_col = "baseline_total_energy_mwh",
  project_energy_col = "project_total_energy_mwh",
  service_col = "service_level_indicator"
)
check_applicability_fuel_switching(baseline, project)
check_applicability_monitoring(monitoring)
assess_ams_iie_applicability(baseline, project, monitoring)
```

# Simulated Dataset

```{r simulation}
set.seed(123)
example_data <- simulate_ams_iie_dataset(n_buildings = 4, n_periods = 6, start_year = 2024, start_month = 7)
knitr::kable(
  head(example_data),
  format = "html",
  digits = 3
)
```

The simulation includes monitoring metadata (`monitoring_period`, `year`,
`month`, `day`, and `monitoring_label`) along with baseline/project parameters,
service indicators, and leakage placeholders.

# Equation Walkthrough

```{r calculations}
baseline_emissions <- calculate_baseline_building_emissions(example_data, group_cols = "building_id")
project_emissions <- calculate_project_building_emissions(example_data, group_cols = "building_id")
leakage_emissions <- calculate_leakage_emissions(
  example_data,
  group_cols = "building_id",
  leakage_col = "leakage_emissions_tco2e"
)
emission_reductions <- estimate_emission_reductions(
  baseline_emissions,
  project_emissions,
  leakage_emissions,
  group_cols = "building_id"
)
knitr::kable(emission_reductions, format = "html", digits = 3)
```

# Monitoring Period Aggregation

```{r monitoring}
period_summary <- aggregate_monitoring_periods(
  example_data,
  period_col = monitoring_label,
  group_cols = "building_id"
)
knitr::kable(period_summary, format = "html", digits = 3)
```

# Meta-Function

```{r meta}
wrapper_results <- estimate_emission_reductions_ams_iie(
  baseline_data = example_data,
  project_data = example_data,
  leakage_data = example_data,
  group_cols = "building_id",
  leakage_args = list(leakage_col = "leakage_emissions_tco2e")
)
knitr::kable(wrapper_results, format = "html", digits = 3)
```

# Function Interdependencies

```{mermaid}
flowchart TD
  A[calculate_baseline_building_emissions] --> D[estimate_emission_reductions]
  B[calculate_project_building_emissions] --> D
  C[calculate_leakage_emissions] --> D
  D --> E[estimate_emission_reductions_ams_iie]
```
