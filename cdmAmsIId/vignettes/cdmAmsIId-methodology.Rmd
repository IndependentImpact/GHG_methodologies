---
title: "AMS-II.D Methodology Walkthrough"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{AMS-II.D Methodology Walkthrough}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Introduction

This vignette demonstrates how to reproduce the AMS-II.D calculations using
`cdmAmsIId`. The methodology covers industrial energy efficiency and fuel
switching projects that improve thermal system performance. The core steps
include estimating baseline emissions, calculating project emissions, accounting
for leakage, and deriving net emission reductions.

# Applicability Checks

```{r applicability}
library(cdmAmsIId)

baseline <- tibble::tibble(
  baseline_fuel_quantity = c(1200, 900),
  baseline_efficiency = c(0.72, 0.68),
  baseline_emission_factor_tco2_per_gj = c(0.094, 0.094)
)
project <- tibble::tibble(
  project_fuel_quantity = c(920, 720),
  project_efficiency = c(0.84, 0.82),
  project_emission_factor_tco2_per_gj = c(0.082, 0.082)
)
monitoring <- tibble::tibble(
  project_fuel_quantity = c(80, 70),
  project_efficiency = c(0.84, 0.8),
  useful_heat_output = c(60, 55)
)

check_applicability_energy_efficiency(baseline, project)
check_applicability_fuel_switching(baseline, project)
check_applicability_monitoring(monitoring)
assess_ams_iid_applicability(baseline, project, monitoring)
```

# Simulated Dataset

```{r simulation}
set.seed(123)
example_data <- simulate_ams_iid_dataset(n_facilities = 4, n_periods = 6, start_year = 2024, start_month = 7)
knitr::kable(
  head(example_data),
  format = "html",
  digits = 3
)
```

The simulation includes monitoring metadata (`monitoring_period`, `year`,
`month`, `day`, and `monitoring_label`) along with baseline/project parameters
and leakage placeholders.

# Equation Walkthrough

```{r calculations}
baseline_emissions <- calculate_baseline_fossil_emissions(example_data, group_cols = "facility_id")
project_emissions <- calculate_project_fossil_emissions(
  example_data,
  group_cols = "facility_id",
  electricity_col = "electricity_emissions_tco2e"
)
leakage_emissions <- calculate_leakage_emissions(
  example_data,
  group_cols = "facility_id",
  leakage_col = "leakage_emissions_tco2e"
)
emission_reductions <- estimate_emission_reductions(
  baseline_emissions,
  project_emissions,
  leakage_emissions,
  group_cols = "facility_id"
)
knitr::kable(emission_reductions, format = "html", digits = 3)
```

# Monitoring Period Aggregation

```{r monitoring}
period_summary <- aggregate_monitoring_periods(
  example_data,
  period_col = monitoring_label,
  group_cols = "facility_id"
)
knitr::kable(period_summary, format = "html", digits = 3)
```

# Meta-Function

```{r meta}
wrapper_results <- estimate_emission_reductions_ams_iid(
  baseline_data = example_data,
  project_data = example_data,
  leakage_data = example_data,
  group_cols = "facility_id",
  project_args = list(electricity_col = "electricity_emissions_tco2e"),
  leakage_args = list(leakage_col = "leakage_emissions_tco2e")
)
knitr::kable(wrapper_results, format = "html", digits = 3)
```

# Function Interdependencies

```{mermaid}
flowchart TD
  A[calculate_baseline_fossil_emissions] --> D[estimate_emission_reductions]
  B[calculate_project_fossil_emissions] --> D
  C[calculate_leakage_emissions] --> D
  D --> E[estimate_emission_reductions_ams_iid]
```

# Function Reference Table

```{r reference-table}
library(dplyr)
reference <- tibble::tribble(
  ~Equation, ~Function, ~Description,
  "(1)", "calculate_baseline_fossil_emissions()", "Aggregates baseline fossil fuel emissions adjusted for efficiency.",
  "(2)", "calculate_project_fossil_emissions()", "Aggregates monitored project emissions including electricity.",
  "(3)", "calculate_leakage_emissions()", "Summarises leakage emissions for the monitoring period.",
  "(4)", "estimate_emission_reductions()", "Combines baseline, project, and leakage emissions to obtain net reductions."
)
knitr::kable(reference, format = "html")
```
